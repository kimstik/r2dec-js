name: Check r2 release

on:
  schedule:
    - cron: '0 * * * *'  # hourly
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: Get latest r2 version
      id: check
      run: |
        LATEST=$(curl -s https://api.github.com/repos/radareorg/radare2/releases/latest | jq -r .tag_name)
        echo "version=$LATEST" >> $GITHUB_OUTPUT
        echo "Latest r2 version: $LATEST"

    - name: Check if artifacts exist
      id: artifacts
      run: |
        VERSION="${{ steps.check.outputs.version }}"
        echo "Checking artifacts for version: $VERSION"
        ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/artifacts --jq ".artifacts[].name" | grep "r2dec.*${VERSION}" || echo "")
        if [ -n "$ARTIFACTS" ]; then
          echo "Found artifacts:"
          echo "$ARTIFACTS"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "No artifacts found for version $VERSION"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Trigger CI workflow
      if: steps.artifacts.outputs.exists == 'false'
      run: |
        echo "Triggering CI for version ${{ steps.check.outputs.version }}"
        gh workflow run ci.yml -R ${{ github.repository }} -f r2_version=${{ steps.check.outputs.version }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up old check runs
      uses: actions/github-script@v7
      with:
        script: |
          const runs = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'check-r2-release.yml',
            per_page: 100
          });
          for (const run of runs.data.workflow_runs) {
            if (run.id !== context.runId && run.status === 'completed') {
              await github.rest.actions.deleteWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });
            }
          }
