name: Check r2 release

on:
  schedule:
    - cron: '0 6 * * *'  # daily at 6:00 UTC
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: Get latest r2 version
      id: check
      run: |
        LATEST=$(curl -s https://api.github.com/repos/radareorg/radare2/releases/latest | jq -r .tag_name)
        echo "version=$LATEST" >> $GITHUB_OUTPUT
        echo "Latest r2 version: $LATEST"

    - name: Restore cached version
      id: cache
      uses: actions/cache/restore@v4
      with:
        path: .last-r2-version
        key: last-r2-version

    - name: Check if new release
      id: compare
      run: |
        LATEST="${{ steps.check.outputs.version }}"
        CACHED=$(cat .last-r2-version 2>/dev/null || echo "")
        echo "Cached: $CACHED"
        echo "Latest: $LATEST"
        if [ "$LATEST" != "$CACHED" ] && [ -n "$LATEST" ]; then
          echo "new_release=true" >> $GITHUB_OUTPUT
          echo "$LATEST" > .last-r2-version
        else
          echo "new_release=false" >> $GITHUB_OUTPUT
        fi

    - name: Save cached version
      if: steps.compare.outputs.new_release == 'true'
      uses: actions/cache/save@v4
      with:
        path: .last-r2-version
        key: last-r2-version-${{ steps.check.outputs.version }}

    - name: Trigger CI workflow
      if: steps.compare.outputs.new_release == 'true'
      run: |
        gh workflow run ci.yml -f r2_version=${{ steps.check.outputs.version }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete this run if no new release
      if: steps.compare.outputs.new_release == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.actions.deleteWorkflowRun({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId
          })
